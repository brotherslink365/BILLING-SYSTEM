<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶™‡ßç‡¶∞‡¶´‡ßá‡¶∂‡¶®‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS Variables & Base Styles */
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #343a40;
            --light-text-color: #6c757d;
            --gradient-main: linear-gradient(90deg, #1f4287, #2a5298);
            --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
        }

        body.dark-mode {
            --primary-color: #4da6ff;
            --secondary-color: #5cb85c;
            --background-color: #1e1e2f;
            --card-background: #27293d;
            --text-color: #f4f7f6;
            --light-text-color: #adb5bd;
            --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        body { background-color: var(--background-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; line-height: 1.6; }

        /* Login Screen */
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: var(--gradient-main); }
        .login-box { background: var(--card-background); padding: 40px; border-radius: 10px; box-shadow: var(--shadow); width: 100%; max-width: 400px; text-align: center; }
        .login-box h2 { margin-bottom: 30px; color: var(--primary-color); }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; background-color: var(--background-color); color: var(--text-color); }
        .login-box button { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }

        /* Header & Navigation */
        header { background: var(--gradient-main); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.5em; font-weight: bold; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .menu-toggle { display: none; background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; }
        .sidebar {
            width: 250px;
            background-color: var(--card-background);
            box-shadow: var(--shadow);
            position: fixed;
            height: 100%;
            overflow-y: auto;
            padding-top: 80px;
            transition: transform 0.3s ease-in-out;
            z-index: 90;
            left: 0;
            top: 0;
        }
        .sidebar a { display: block; padding: 15px 20px; text-decoration: none; color: var(--text-color); border-left: 5px solid transparent; font-weight: 500; transition: all 0.3s; }
        .sidebar a:hover, .sidebar a.active { background-color: var(--background-color); border-left-color: var(--primary-color); color: var(--primary-color); }
        .content-area { margin-left: 250px; padding: 20px; transition: margin-left 0.3s ease-in-out; }
        .content-view { display: none; padding-top: 10px; }
        .active-view { display: block; }

        /* Dashboard UI */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-background); padding: 25px; border-radius: 8px; box-shadow: var(--shadow); border-left: 5px solid var(--primary-color); transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-card h3 { font-size: 1em; color: var(--light-text-color); margin-bottom: 5px; }
        .stat-card p { font-size: 2.2em; font-weight: bold; }
        .progress-bar-container { margin-top: 10px; height: 8px; border-radius: 4px; overflow: hidden; background-color: #eee; }
        .progress-bar { height: 100%; background: var(--secondary-color); transition: width 0.5s; }

        /* Tables & Data Sections */
        .data-section { background: var(--card-background); padding: 20px; border-radius: 8px; box-shadow: var(--shadow); margin-top: 20px; overflow-x: auto; }
        .data-section h3 { margin-bottom: 15px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; color: var(--primary-color); }
        table { width: 100%; border-collapse: collapse; min-width: 750px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: var(--background-color); font-weight: bold; text-transform: uppercase; }
        tr:hover { background-color: var(--background-color); }

        /* Forms & Buttons */
        .btn-primary { background-color: var(--primary-color); color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-weight: 500; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-action { background-color: var(--secondary-color); color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-left: 5px; font-weight: 500; }
        .btn-action:hover { background-color: #1e7e34; }
        .btn-danger { background-color: #dc3545; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-left: 5px; font-weight: 500; }
        .form-group { margin-bottom: 15px; }
        .form-group input, .form-group select { padding: 10px; border: 1px solid #ced4da; border-radius: 5px; background-color: var(--background-color); color: var(--text-color); width: 100%; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-grid > .full-width { grid-column: 1 / -1; }
        
        /* Contact Icons */
        .contact-icons a { 
            display: inline-block; 
            margin: 0 2px; 
            color: var(--primary-color); 
            font-size: 1.1em; 
            transition: color 0.2s; 
        }
        .contact-icons a:hover { color: var(--secondary-color); }
        .contact-icons .fa-whatsapp { color: #25D366; }
        .contact-icons .fa-whatsapp:hover { color: #128C7E; }
        .contact-icons .fa-phone-alt { color: #007bff; }
        .contact-icons .fa-sms { color: #ffc107; }
        
        /* Chart Simulation */
        .chart-container { height: 250px; background: var(--background-color); border-radius: 8px; padding: 15px; margin-top: 20px; display: flex; align-items: flex-end; justify-content: space-around; }
        .bar { width: 10%; background: var(--primary-color); margin: 0 5px; transition: height 0.5s; position: relative; }
        .bar-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 0.8em; color: var(--light-text-color); white-space: nowrap; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.4); }
        .modal-content { background-color: var(--card-background); margin: 10% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: var(--shadow); position: relative; }
        .close-btn { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .close-btn:hover { color: #000; }

        /* Loading Spinner */
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar { 
                transform: translateX(-100%); 
                padding-top: 60px; 
            }
            .sidebar.open { 
                transform: translateX(0); 
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            }
            .content-area { 
                margin-left: 0; 
                padding-top: 15px; 
            }
            .menu-toggle { display: block; }
            .user-info span { display: none; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .chart-container { height: 200px; }
            table { min-width: 100%; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h2>‡¶™‡ßç‡¶∞‡¶´‡ßá‡¶∂‡¶®‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</h2>
            <input type="text" id="username" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ">
            <input type="password" id="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
            <button onclick="login()">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <p id="loginMessage" style="color: red; margin-top: 10px;"></p>
            <div class="login-info" style="margin-top: 20px;">
                <p><strong>‡¶°‡ßá‡¶Æ‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü:</strong></p>
                <p>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®: admin / admin</p>
                <p>‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡¶∞: rahim / 1234</p>
            </div>
        </div>
    </div>

    <div class="main-app" id="mainApp" style="display: none;">

        <header>
            <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
            <div class="logo">üöÄ ‡¶¨‡¶ø‡¶≤‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</div>
            <div class="user-info">
                <span id="currentUserRole">‡¶∞‡ßã‡¶≤: ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®</span>
                <span id="currentUserName">‡¶á‡¶â‡¶ú‡¶æ‡¶∞: admin</span>
                <label class="switch" style="display: flex; align-items: center; gap: 5px;">
                    <i class="fas fa-moon"></i>
                    <input type="checkbox" id="darkModeToggle" style="width: auto;">
                </label>
                <button onclick="logout()" class="btn-primary" style="padding: 6px 10px;"><i class="fas fa-sign-out-alt"></i> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
            </div>
        </header>

        <div class="sidebar" id="sidebar">
            <a href="#" class="nav-link active" data-view="dashboard"><i class="fas fa-chart-line"></i> ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a>
            <a href="#" class="nav-link" data-view="customers"><i class="fas fa-users"></i> ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</a>
            <a href="#" class="nav-link" data-view="billing"><i class="fas fa-receipt"></i> ‡¶¨‡¶ø‡¶≤ ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º</a>
            <a href="#" class="nav-link" data-view="reports"><i class="fas fa-chart-bar"></i> ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü</a>
            <a href="#" class="nav-link admin-only" data-view="collectors"><i class="fas fa-people-carry"></i> ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡¶∞ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç</a>
            <a href="#" class="nav-link admin-only" data-view="settings"><i class="fas fa-cogs"></i> ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</a>
        </div>

        <div class="content-area">
            <!-- Dashboard View -->
            <div id="dashboard" class="content-view active-view">
                <h2>üìä ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°: ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶ø‡¶∏‡¶ü‡¶ø‡¶ï‡ßç‡¶∏</h2>
                <div class="dashboard-grid">
                    <div class="stat-card" style="border-left-color: #28a745;">
                        <h3>‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® (‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï)</h3>
                        <p id="statMonthlyCollection">‡ß≥ 0</p>
                        <small>‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶Ö‡¶∞‡ßç‡¶ú‡¶®: <span id="progressPercentage">0%</span></small>
                        <div class="progress-bar-container"><div class="progress-bar" id="monthlyTargetProgress" style="width: 0%;"></div></div>
                    </div>
                    <div class="stat-card" style="border-left-color: #ffc107;">
                        <h3>‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶¨‡¶ø‡¶≤</h3>
                        <p id="statDueAmount">‡ß≥ 0</p>
                    </div>
                    <div class="stat-card" style="border-left-color: #17a2b8;">
                        <h3>‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</h3>
                        <p id="statActiveCustomers">0</p>
                    </div>
                    <div class="stat-card" style="border-left-color: #dc3545;">
                        <h3>‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡¶§‡¶æ (‡¶¨‡¶ø‡¶≤)</h3>
                        <p id="statFailedPayments">0</p>
                    </div>
                </div>
                
                <div class="data-section">
                    <h3>‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø</h3>
                    <div class="chart-container" id="areaChart"></div>
                </div>
            </div>

            <!-- Customer Management View -->
            <div id="customers" class="content-view">
                <h2>üë§ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h2>
                <button class="btn-primary admin-only" onclick="openCustomerModal('add')"><i class="fas fa-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶Ø‡ßã‡¶ó</button>

                <div class="data-section">
                    <h3>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <input type="text" id="customerSearch" placeholder="‡¶®‡¶æ‡¶Æ, ‡¶´‡ßã‡¶®, ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." style="flex-grow: 1; min-width: 200px;">
                        <select id="customerFilterStatus" style="width: 150px;">
                            <option value="">‡¶∏‡¶ï‡¶≤ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</option>
                            <option value="Active">‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º</option>
                            <option value="Inactive">‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º</option>
                        </select>
                        <button class="btn-primary" onclick="filterCustomers()">‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞</button>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>‡¶Ü‡¶á‡¶°‡¶ø</th>
                                <th>‡¶®‡¶æ‡¶Æ</th>
                                <th>‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ</th>
                                <th>‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú (‡ß≥)</th>
                                <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                                <th>‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ?</th>
                                <th>‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó</th>
                                <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Billing View -->
            <div id="billing" class="content-view">
                <h2>üí∞ ‡¶¨‡¶ø‡¶≤ ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º ‡¶ì ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°</h2>
                <div class="data-section">
                    <h3>‡¶¨‡¶ø‡¶≤ ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π</h3>
                    <form id="billCollectionForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label for="billCustomerId">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®:</label>
                            <select id="billCustomerId" required></select>
                        </div>
                        <div class="form-group">
                            <label for="billAmount">‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥):</label>
                            <input type="number" id="billAmount" required min="10" placeholder="‡¶™‡ßç‡¶∞‡¶ï‡ßÉ‡¶§ ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º">
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°:</label>
                            <select id="paymentMethod" required>
                                <option value="Cash">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂</option>
                                <option value="bKash">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option>
                                <option value="Nagad">‡¶®‡¶ó‡¶¶</option>
                                <option value="Rocket">‡¶∞‡¶ï‡ßá‡¶ü</option>
                                <option value="Bank">‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="collectorId">‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡¶∞:</label>
                            <select id="collectorId" required></select>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1; text-align: right;">
                            <button type="submit" class="btn-primary"><i class="fas fa-check"></i> ‡¶¨‡¶ø‡¶≤ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Reports View -->
            <div id="reports" class="content-view">
                <h2>üìà ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø‡¶ï‡ßç‡¶∏</h2>
                <div class="data-section">
                    <h3>‡¶¨‡¶ø‡¶≤ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                        <label for="startDate">‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
                        <input type="date" id="startDate" style="width: 150px; padding: 8px;">
                        <label for="endDate">‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
                        <input type="date" id="endDate" style="width: 150px; padding: 8px;">
                        <button class="btn-primary" onclick="filterTransactionsByDate()" style="padding: 8px 15px;"><i class="fas fa-filter"></i> ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞</button>
                        <button class="btn-action" onclick="exportTransactionToCSV()" style="padding: 8px 15px;"><i class="fas fa-file-csv"></i> CSV ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                                <th>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</th>
                                <th>‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú (‡ß≥)</th>
                                <th>‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º (‡ß≥)</th>
                                <th>‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø</th>
                                <th>‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡¶∞</th>
                                <th>‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody">
                            <tr><td colspan="7" style="text-align: center;">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á‡•§</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Collector Management View -->
            <div id="collectors" class="content-view admin-only-view">
                <h2>üíº ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü: ‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç</h2>
                <div class="data-section">
                    <h3>‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡¶∞ ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø</h3>
                    <table id="collectorPerformanceTable">
                        <thead>
                            <tr>
                                <th>‡¶®‡¶æ‡¶Æ</th>
                                <th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ</th>
                                <th>‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º (‡ß≥)</th>
                                <th>‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü (%)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings" class="content-view admin-only-view">
                <h2>‚öôÔ∏è ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h2>
                
                <div class="data-section">
                    <h3>üó∫Ô∏è ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h3>
                    <div class="form-grid">
                        <div>
                            <h4>‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h4>
                            <form id="addAreaForm">
                                <div class="form-group">
                                    <label for="newAreaName">‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶®‡¶æ‡¶Æ:</label>
                                    <input type="text" id="newAreaName" required placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶ß‡¶æ‡¶®‡¶Æ‡¶®‡ßç‡¶°‡¶ø">
                                </div>
                                <button type="submit" class="btn-primary" style="width: 100%;"><i class="fas fa-map-marker-alt"></i> ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                            </form>
                        </div>
                        <div>
                            <h4>‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h4>
                            <form id="editAreaForm">
                                <div class="form-group">
                                    <label for="existingAreaSelect">‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®:</label>
                                    <select id="existingAreaSelect" required onchange="loadAreaForEdit(this.value)"></select>
                                </div>
                                <div class="form-group">
                                    <label for="updatedAreaName">‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ:</label>
                                    <input type="text" id="updatedAreaName" placeholder="‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶¶‡¶ø‡¶®">
                                </div>
                                <div class="form-group" style="display: flex; gap: 10px;">
                                    <button type="submit" class="btn-action" style="flex-grow: 1; padding: 10px;"><i class="fas fa-save"></i> ‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                                    <button type="button" class="btn-danger" onclick="deleteArea()" style="flex-grow: 1; padding: 10px;"><i class="fas fa-trash-alt"></i> ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="data-section" style="margin-top: 20px;">
                    <h3>üë§ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ì ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h3>
                    <div class="form-grid">
                        <div class="full-width">
                            <h4>‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ (‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡¶∞/‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®) ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h4>
                            <form id="addUserForm">
                                <div class="form-group"><label for="newUsername">‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ:</label><input type="text" id="newUsername" required></div>
                                <div class="form-group"><label for="newPassword">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°:</label><input type="password" id="newPassword" required></div>
                                <div class="form-group"><label for="newUserName">‡¶®‡¶æ‡¶Æ:</label><input type="text" id="newUserName" required></div>
                                <div class="form-group"><label for="newUserRole">‡¶∞‡ßã‡¶≤:</label>
                                    <select id="newUserRole" required>
                                        <option value="collector">‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡¶∞</option>
                                        <option value="admin">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®</option>
                                    </select>
                                </div>
                                <div class="form-group"><label for="newUserTarget">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü (‡ß≥):</label><input type="number" id="newUserTarget" required min="1000"></div>
                                <button type="submit" class="btn-primary" style="width: 100%;"><i class="fas fa-user-plus"></i> ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                            </form>
                        </div>
                        
                        <div class="full-width">
                            <h4>‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® / ‡¶è‡¶°‡¶ø‡¶ü / ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h4>
                            <form id="editUserForm">
                                <div class="form-group"><label for="editUsername">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®:</label>
                                    <select id="editUsername" required onchange="loadUserForEdit(this.value)"></select>
                                </div>
                                <div class="form-group"><label for="editPassword">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï):</label><input type="password" id="editPassword" placeholder="‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶¶‡¶ø‡¶®"></div>
                                <div class="form-group"><label for="editUserName">‡¶®‡¶æ‡¶Æ:</label><input type="text" id="editUserName" required></div>
                                <div class="form-group"><label for="editUserRole">‡¶∞‡ßã‡¶≤:</label>
                                    <select id="editUserRole" required disabled></select>
                                </div>
                                <div class="form-group"><label for="editUserTarget">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü (‡ß≥):</label><input type="number" id="editUserTarget" required min="1000"></div>
                                
                                <div class="form-group" style="display: flex; gap: 10px;">
                                    <button type="submit" class="btn-action" style="flex-grow: 1;"><i class="fas fa-save"></i> ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                                    <button type="button" class="btn-danger" style="flex-grow: 1;" onclick="deleteUser()"><i class="fas fa-trash-alt"></i> ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="data-section" style="margin-top: 20px;">
                    <h3>ü§ñ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶∂‡¶®</h3>
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn-primary" onclick="autoGenerateBill()"><i class="fas fa-file-invoice"></i> ‡¶Ö‡¶ü‡ßã ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡¶ø‡¶≤ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶∂‡¶®</button>
                        <button class="btn-action" onclick="alert('‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡¶¶‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá SMS ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá (Demo)')"><i class="fas fa-sms"></i> ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶∞‡¶ø‡¶Æ‡¶æ‡¶á‡¶®‡ßç‡¶°‡¶æ‡¶∞ (‡¶¨‡¶æ‡¶≤‡ßç‡¶ï SMS)</button>
                    </div>
                </div>
                
                <div class="data-section" style="margin-top: 20px;">
                    <h3>‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h3>
                    <button class="btn-action" onclick="exportData('csv')"><i class="fas fa-file-csv"></i> ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶°‡ßá‡¶ü‡¶æ CSV ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
                    <button class="btn-action" onclick="exportData('json')"><i class="fas fa-download"></i> ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ (JSON)</button>
                    <button class="btn-danger" onclick="alert('‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá (Demo)')"><i class="fas fa-undo"></i> ‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</button>
                </div>
            </div>
        </div>
    </div> 
    
    <!-- Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeCustomerModal()">&times;</span>
            <h3 id="customerModalTitle">‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶Ø‡ßã‡¶ó</h3>
            <form id="customerForm">
                <input type="hidden" id="customerId" value="">
                <div class="form-group"><label for="customerName">‡¶®‡¶æ‡¶Æ:</label><input type="text" id="customerName" required></div>
                <div class="form-group"><label for="customerPhone">‡¶´‡ßã‡¶®:</label><input type="text" id="customerPhone" required></div>
                <div class="form-group"><label for="customerArea">‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ:</label>
                    <select id="customerArea" required></select>
                </div>
                <div class="form-group"><label for="customerPackage">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú (‡ß≥):</label><input type="number" id="customerPackage" required min="100"></div>
                <div class="form-group"><label for="customerStatus">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏:</label>
                    <select id="customerStatus" required>
                        <option value="Active">‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º</option><option value="Inactive">‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary" id="customerSubmitBtn">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </form>
        </div>
    </div>

    <script>
        // Supabase Configuration - USING YOUR ACTUAL CREDENTIALS
        const SUPABASE_URL = 'https://mqfwgraaefmjhpzdkrfi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xZndncmFhZWZtamhwemRrcmZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2Nzc0MzUsImV4cCI6MjA3NjI1MzQzNX0.jmuHhliqISdfR_r_aOJUR5ruKdwMcgDPEG4qz4TJfjg';
        
        let supabase;
        let currentUser = null;

        // Initialize Supabase
        function initSupabase() {
            supabase = supabaseClient.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase initialized successfully');
        }

        // Global State & Initial Data
        const USER_ROLES = { ADMIN: 'admin', COLLECTOR: 'collector' };
        
        let DEMO_USERS;
        let DEMO_AREAS;
        let customers = [];
        let transactions = [];
        let currentRole = null;
        let currentUsername = null;
        
        const LOCAL_STORAGE_KEYS = {
            USERS: 'billingUsers',
            AREAS: 'billingAreas',
            CUSTOMERS: 'billingCustomers',
            TRANSACTIONS: 'billingTransactions'
        };

        // Default initial data for first run
        const DEFAULT_DATA = {
            users: {
                'admin': { password: 'admin', role: USER_ROLES.ADMIN, name: '‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®', target: 50000 },
                'rahim': { password: '1234', role: USER_ROLES.COLLECTOR, name: '‡¶∞‡¶π‡¶ø‡¶Æ', target: 25000 }
            },
            areas: ['‡¶â‡¶§‡ßç‡¶§‡¶∞', '‡¶¶‡¶ï‡ßç‡¶∑‡¶ø‡¶£', '‡¶™‡ßÇ‡¶∞‡ßç‡¶¨', '‡¶™‡¶∂‡ßç‡¶ö‡¶ø‡¶Æ'],
            customers: [
                { id: 101, name: '‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤ ‡¶ï‡¶∞‡¶ø‡¶Æ', phone: '01712345678', area: '‡¶â‡¶§‡ßç‡¶§‡¶∞', package: 500, status: 'Active', due: true, collector: 'rahim' },
                { id: 102, name: '‡¶∞‡¶π‡¶ø‡¶Æ‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ', phone: '01887654321', area: '‡¶¶‡¶ï‡ßç‡¶∑‡¶ø‡¶£', package: 600, status: 'Active', due: false, collector: 'rahim' }
            ],
            transactions: [
                { id: 1, customer_id: 102, customer_name: '‡¶∞‡¶π‡¶ø‡¶Æ‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ', package: 600, amount: 600, method: 'Cash', collector: 'rahim', created_at: new Date().toISOString() }
            ]
        };

        // Utility Functions
        function loadInitialData() {
            DEMO_USERS = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.USERS)) || DEFAULT_DATA.users;
            DEMO_AREAS = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.AREAS)) || DEFAULT_DATA.areas;
            
            // Load from localStorage as fallback
            const localCustomers = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.CUSTOMERS)) || DEFAULT_DATA.customers;
            const localTransactions = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.TRANSACTIONS)) || DEFAULT_DATA.transactions;
            
            // Use local data if Supabase data not loaded yet
            if (customers.length === 0) customers = localCustomers;
            if (transactions.length === 0) transactions = localTransactions;
        }

        function saveAllData() {
            localStorage.setItem(LOCAL_STORAGE_KEYS.USERS, JSON.stringify(DEMO_USERS));
            localStorage.setItem(LOCAL_STORAGE_KEYS.AREAS, JSON.stringify(DEMO_AREAS));
            localStorage.setItem(LOCAL_STORAGE_KEYS.CUSTOMERS, JSON.stringify(customers));
            localStorage.setItem(LOCAL_STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));
        }

        function generateUniqueId() { 
            return customers.length > 0 ? Math.max(...customers.map(c => c.id)) + 1 : 101; 
        }

        function generateTransactionId() { 
            return transactions.length > 0 ? Math.max(...transactions.map(t => t.id)) + 1 : 1; 
        }

        function toggleDarkMode(isDark) {
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem('darkMode', isDark);
            document.getElementById('darkModeToggle').checked = isDark;
        }

        // Navigation & Menu Functions
        function showView(viewId) {
            console.log('Showing view:', viewId);
            
            // Hide all content views
            const views = document.querySelectorAll('.content-view');
            views.forEach(view => {
                view.classList.remove('active-view');
            });

            // Show the selected view
            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.add('active-view');
            }

            // Update active menu item
            const links = document.querySelectorAll('.nav-link');
            links.forEach(link => {
                link.classList.remove('active');
            });
            
            const activeLink = document.querySelector(`.nav-link[data-view="${viewId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }

            // Close sidebar on mobile
            if (window.innerWidth <= 992) {
                document.getElementById('sidebar').classList.remove('open');
            }

            // Load data for specific views
            if (viewId === 'dashboard') updateDashboard();
            if (viewId === 'customers') renderCustomerTable();
            if (viewId === 'billing') {
                populateBillingCustomerDropdown();
                populateCollectorDropdown();
            }
            if (viewId === 'reports') renderTransactionTable();
            if (viewId === 'collectors' && currentRole === USER_ROLES.ADMIN) renderCollectorPerformance();
            if (viewId === 'settings' && currentRole === USER_ROLES.ADMIN) {
                populateAreaDropdowns();
                populateUserDropdowns();
            }
        }

        function setupNavigation() {
            // Menu toggle for mobile
            document.getElementById('menuToggle').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('open');
            });

            // Navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const viewId = this.getAttribute('data-view');
                    console.log('Navigation clicked:', viewId);
                    showView(viewId);
                });
            });

            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('change', function(e) {
                toggleDarkMode(e.target.checked);
            });
        }

        // Modal Functions
        function openCustomerModal(mode, customerId = null) {
            const modal = document.getElementById('customerModal');
            const form = document.getElementById('customerForm');
            const title = document.getElementById('customerModalTitle');
            const submitBtn = document.getElementById('customerSubmitBtn');

            if (mode === 'add') {
                title.textContent = '‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶Ø‡ßã‡¶ó';
                submitBtn.textContent = '‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®';
                form.reset();
                document.getElementById('customerId').value = '';
            } else if (mode === 'edit') {
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    title.textContent = '‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®';
                    submitBtn.textContent = '‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®';
                    document.getElementById('customerId').value = customer.id;
                    document.getElementById('customerName').value = customer.name;
                    document.getElementById('customerPhone').value = customer.phone;
                    document.getElementById('customerArea').value = customer.area;
                    document.getElementById('customerPackage').value = customer.package;
                    document.getElementById('customerStatus').value = customer.status;
                }
            }

            populateAreaDropdown('customerArea');
            modal.style.display = 'block';
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('customerModal');
            if (event.target === modal) {
                closeCustomerModal();
            }
        });

        // Customer Form Handler - FIXED
        async function handleCustomerSubmit(e) {
            e.preventDefault();
            console.log('Customer form submitted');
            
            const customerId = document.getElementById('customerId').value;
            const customerData = {
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                area: document.getElementById('customerArea').value,
                package: parseInt(document.getElementById('customerPackage').value),
                status: document.getElementById('customerStatus').value,
                due: true,
                collector: currentUsername
            };

            try {
                if (customerId) {
                    // Update existing customer
                    console.log('Updating customer:', customerId);
                    await updateCustomerInSupabase(customerId, customerData);
                    const index = customers.findIndex(c => c.id === parseInt(customerId));
                    if (index !== -1) {
                        customers[index] = { ...customers[index], ...customerData };
                    }
                    alert('‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
                } else {
                    // Add new customer
                    console.log('Adding new customer');
                    customerData.id = generateUniqueId();
                    const result = await saveCustomerToSupabase(customerData);
                    if (result && result[0]) {
                        customers.push(result[0]);
                        alert('‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
                    } else {
                        // Fallback to local storage if Supabase fails
                        customers.push(customerData);
                        alert('‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! (Local Storage)');
                    }
                }

                saveAllData();
                renderCustomerTable();
                closeCustomerModal();
                updateDashboard();
            } catch (error) {
                console.error('Error saving customer:', error);
                alert('‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            }
        }

        // Supabase Database Functions
        async function loadCustomersFromSupabase() {
            try {
                console.log('Loading customers from Supabase...');
                const { data, error } = await supabase
                    .from('customers')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                if (data && data.length > 0) {
                    customers = data;
                    console.log(`Loaded ${customers.length} customers from Supabase`);
                    saveAllData(); // Sync to localStorage
                } else {
                    console.log('No customers found in Supabase, using default data');
                }
            } catch (error) {
                console.error('Error loading customers from Supabase:', error);
                // Fallback to localStorage
                const localCustomers = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.CUSTOMERS)) || DEFAULT_DATA.customers;
                if (localCustomers.length > 0) {
                    customers = localCustomers;
                    console.log(`Loaded ${customers.length} customers from localStorage as fallback`);
                }
            }
        }

        async function loadTransactionsFromSupabase() {
            try {
                console.log('Loading transactions from Supabase...');
                const { data, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                
                if (data && data.length > 0) {
                    transactions = data;
                    console.log(`Loaded ${transactions.length} transactions from Supabase`);
                    saveAllData(); // Sync to localStorage
                } else {
                    console.log('No transactions found in Supabase, using default data');
                }
            } catch (error) {
                console.error('Error loading transactions from Supabase:', error);
                // Fallback to localStorage
                const localTransactions = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.TRANSACTIONS)) || DEFAULT_DATA.transactions;
                if (localTransactions.length > 0) {
                    transactions = localTransactions;
                    console.log(`Loaded ${transactions.length} transactions from localStorage as fallback`);
                }
            }
        }

        async function saveCustomerToSupabase(customer) {
            try {
                console.log('Saving customer to Supabase:', customer);
                const { data, error } = await supabase
                    .from('customers')
                    .insert([customer])
                    .select();

                if (error) throw error;
                console.log('Customer saved successfully:', data);
                return data;
            } catch (error) {
                console.error('Error saving customer to Supabase:', error);
                throw error;
            }
        }

        async function saveTransactionToSupabase(transaction) {
            try {
                console.log('Saving transaction to Supabase:', transaction);
                const { data, error } = await supabase
                    .from('transactions')
                    .insert([transaction])
                    .select();

                if (error) throw error;
                console.log('Transaction saved successfully:', data);
                return data;
            } catch (error) {
                console.error('Error saving transaction to Supabase:', error);
                throw error;
            }
        }

        async function deleteCustomerFromSupabase(customerId) {
            try {
                console.log('Deleting customer from Supabase:', customerId);
                const { error } = await supabase
                    .from('customers')
                    .delete()
                    .eq('id', customerId);

                if (error) throw error;
                console.log('Customer deleted successfully');
            } catch (error) {
                console.error('Error deleting customer from Supabase:', error);
                throw error;
            }
        }

        async function updateCustomerInSupabase(customerId, updates) {
            try {
                console.log('Updating customer in Supabase:', customerId, updates);
                const { data, error } = await supabase
                    .from('customers')
                    .update(updates)
                    .eq('id', customerId)
                    .select();

                if (error) throw error;
                console.log('Customer updated successfully:', data);
                return data;
            } catch (error) {
                console.error('Error updating customer in Supabase:', error);
                throw error;
            }
        }

        // Authentication & Role Management
        async function login() {
            loadInitialData();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const messageEl = document.getElementById('loginMessage');
            const user = DEMO_USERS[username];

            if (user && user.password === password) {
                currentRole = user.role;
                currentUsername = username;
                localStorage.setItem('currentRole', currentRole);
                localStorage.setItem('currentUsername', currentUsername);
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // Initialize Supabase and load data
                initSupabase();
                await loadCustomersFromSupabase();
                await loadTransactionsFromSupabase();
                
                initializeApp();
            } else {
                messageEl.textContent = '‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°‡•§';
            }
        }

        function logout() {
            saveAllData();
            localStorage.removeItem('currentRole');
            localStorage.removeItem('currentUsername');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        }

        function applyRolePermissions() {
            const adminOnlyElements = document.querySelectorAll('.admin-only, .admin-only-view');
            const isAdmin = currentRole === USER_ROLES.ADMIN;

            adminOnlyElements.forEach(el => {
                el.style.display = isAdmin ? '' : 'none';
            });

            document.getElementById('currentUserRole').textContent = `‡¶∞‡ßã‡¶≤: ${isAdmin ? '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®' : '‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡¶∞'}`;
            document.getElementById('currentUserName').textContent = `‡¶á‡¶â‡¶ú‡¶æ‡¶∞: ${DEMO_USERS[currentUsername].name}`;
        }

        function initializeApp() {
            loadInitialData();
            applyRolePermissions();
            setupNavigation();
            setupFormHandlers();

            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            toggleDarkMode(savedDarkMode);

            // Show dashboard by default
            showView('dashboard');
        }

        // Setup Form Handlers
        function setupFormHandlers() {
            // Customer form
            const customerForm = document.getElementById('customerForm');
            if (customerForm) {
                customerForm.addEventListener('submit', handleCustomerSubmit);
            }

            // Billing form
            const billForm = document.getElementById('billCollectionForm');
            if (billForm) {
                billForm.addEventListener('submit', handleBillCollection);
            }

            // Area forms
            const addAreaForm = document.getElementById('addAreaForm');
            if (addAreaForm) {
                addAreaForm.addEventListener('submit', handleAddArea);
            }

            const editAreaForm = document.getElementById('editAreaForm');
            if (editAreaForm) {
                editAreaForm.addEventListener('submit', handleEditArea);
            }

            // User forms
            const addUserForm = document.getElementById('addUserForm');
            if (addUserForm) {
                addUserForm.addEventListener('submit', handleAddUser);
            }

            const editUserForm = document.getElementById('editUserForm');
            if (editUserForm) {
                editUserForm.addEventListener('submit', handleEditUser);
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const monthlyTarget = DEMO_USERS[currentUsername].target || 50000;

            const monthlyTransactions = transactions.filter(t => {
                const tDate = new Date(t.created_at || t.time);
                return tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;
            });

            const monthlyCollection = monthlyTransactions.reduce((sum, t) => sum + t.amount, 0);
            const progressPercentage = Math.min(100, Math.round((monthlyCollection / monthlyTarget) * 100));

            document.getElementById('statMonthlyCollection').textContent = `‡ß≥ ${monthlyCollection.toLocaleString()}`;
            document.getElementById('statDueAmount').textContent = `‡ß≥ ${customers.filter(c => c.due).reduce((sum, c) => sum + c.package, 0).toLocaleString()}`;
            document.getElementById('statActiveCustomers').textContent = customers.filter(c => c.status === 'Active').length;
            document.getElementById('statFailedPayments').textContent = '0';
            document.getElementById('progressPercentage').textContent = `${progressPercentage}%`;
            document.getElementById('monthlyTargetProgress').style.width = `${progressPercentage}%`;

            renderAreaChart();
        }

        function renderAreaChart() {
            const areaChartEl = document.getElementById('areaChart');
            areaChartEl.innerHTML = '';

            const areaData = {};
            DEMO_AREAS.forEach(area => areaData[area] = 0);

            transactions.forEach(t => {
                const customer = customers.find(c => c.id === t.customer_id);
                if (customer) areaData[customer.area] += t.amount;
            });

            const maxAmount = Math.max(...Object.values(areaData));
            Object.entries(areaData).forEach(([area, amount]) => {
                const height = maxAmount > 0 ? (amount / maxAmount) * 100 : 0;
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${height}%`;
                bar.innerHTML = `<div class="bar-label">${area}<br>‡ß≥${amount.toLocaleString()}</div>`;
                areaChartEl.appendChild(bar);
            });
        }

        // Customer Management
        function renderCustomerTable() {
            const tbody = document.getElementById('customerTableBody');
            tbody.innerHTML = '';

            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</td></tr>';
                return;
            }

            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.id}</td>
                    <td>${customer.name}</td>
                    <td>${customer.area}</td>
                    <td>‡ß≥ ${customer.package.toLocaleString()}</td>
                    <td><span style="color: ${customer.status === 'Active' ? 'green' : 'red'}">${customer.status}</span></td>
                    <td style="color: ${customer.due ? 'red' : 'green'}; font-weight: bold;">${customer.due ? '‡¶π‡ßç‡¶Ø‡¶æ‡¶Å' : '‡¶®‡¶æ'}</td>
                    <td class="contact-icons">
                        <a href="tel:${customer.phone}" title="‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®"><i class="fas fa-phone-alt"></i></a>
                        <a href="https://wa.me/88${customer.phone}" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                        <a href="sms:${customer.phone}" title="SMS"><i class="fas fa-sms"></i></a>
                    </td>
                    <td>
                        <button class="btn-action" onclick="openCustomerModal('edit', ${customer.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn-danger admin-only" onclick="deleteCustomer(${customer.id})"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function deleteCustomer(id) {
            if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                try {
                    await deleteCustomerFromSupabase(id);
                    customers = customers.filter(c => c.id !== id);
                    saveAllData();
                    renderCustomerTable();
                    alert('‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
                } catch (error) {
                    alert('‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
                    console.error('Error deleting customer:', error);
                }
            }
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const statusFilter = document.getElementById('customerFilterStatus').value;

            const filtered = customers.filter(customer => {
                const matchesSearch = customer.name.toLowerCase().includes(searchTerm) || 
                                    customer.phone.includes(searchTerm) || 
                                    customer.area.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || customer.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            const tbody = document.getElementById('customerTableBody');
            tbody.innerHTML = '';

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</td></tr>';
                return;
            }

            filtered.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.id}</td>
                    <td>${customer.name}</td>
                    <td>${customer.area}</td>
                    <td>‡ß≥ ${customer.package.toLocaleString()}</td>
                    <td><span style="color: ${customer.status === 'Active' ? 'green' : 'red'}">${customer.status}</span></td>
                    <td style="color: ${customer.due ? 'red' : 'green'}; font-weight: bold;">${customer.due ? '‡¶π‡ßç‡¶Ø‡¶æ‡¶Å' : '‡¶®‡¶æ'}</td>
                    <td class="contact-icons">
                        <a href="tel:${customer.phone}" title="‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®"><i class="fas fa-phone-alt"></i></a>
                        <a href="https://wa.me/88${customer.phone}" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                        <a href="sms:${customer.phone}" title="SMS"><i class="fas fa-sms"></i></a>
                    </td>
                    <td>
                        <button class="btn-action" onclick="openCustomerModal('edit', ${customer.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn-danger admin-only" onclick="deleteCustomer(${customer.id})"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Billing Functions
        function populateBillingCustomerDropdown() {
            const dropdown = document.getElementById('billCustomerId');
            dropdown.innerHTML = '<option value="">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';

            const dueCustomers = customers.filter(c => c.due && c.status === 'Active');
            dueCustomers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} (${customer.area}) - ‡ß≥${customer.package}`;
                dropdown.appendChild(option);
            });
        }

        function populateCollectorDropdown() {
            const dropdown = document.getElementById('collectorId');
            dropdown.innerHTML = '';

            Object.entries(DEMO_USERS).forEach(([username, user]) => {
                if (user.role === USER_ROLES.COLLECTOR || currentRole === USER_ROLES.ADMIN) {
                    const option = document.createElement('option');
                    option.value = username;
                    option.textContent = user.name;
                    if (username === currentUsername) option.selected = true;
                    dropdown.appendChild(option);
                }
            });
        }

        async function handleBillCollection(e) {
            e.preventDefault();
            const customerId = parseInt(document.getElementById('billCustomerId').value);
            const amount = parseInt(document.getElementById('billAmount').value);
            const method = document.getElementById('paymentMethod').value;
            const collector = document.getElementById('collectorId').value;

            const customer = customers.find(c => c.id === customerId);
            if (!customer) return alert('‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§');

            const transaction = {
                customer_id: customerId,
                customer_name: customer.name,
                package: customer.package,
                amount: amount,
                method: method,
                collector: collector
            };

            try {
                // Save transaction to Supabase
                const result = await saveTransactionToSupabase(transaction);
                if (result && result[0]) {
                    transactions.push(result[0]);
                }

                // Update customer due status
                customer.due = false;
                await updateCustomerInSupabase(customerId, { due: false });

                saveAllData();
                alert('‡¶¨‡¶ø‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
                e.target.reset();
                populateBillingCustomerDropdown();
                updateDashboard();
            } catch (error) {
                alert('‡¶¨‡¶ø‡¶≤ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                console.error('Error saving transaction:', error);
            }
        }

        // Area Management Functions
        function populateAreaDropdowns() {
            const dropdowns = ['customerArea', 'existingAreaSelect'];
            dropdowns.forEach(id => populateAreaDropdown(id));
        }

        function populateAreaDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;

            dropdown.innerHTML = '';
            DEMO_AREAS.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                dropdown.appendChild(option);
            });
        }

        function handleAddArea(e) {
            e.preventDefault();
            const areaName = document.getElementById('newAreaName').value.trim();
            if (!areaName) return;

            if (DEMO_AREAS.includes(areaName)) {
                alert('‡¶è‡¶á ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶®‡•§');
                return;
            }

            DEMO_AREAS.push(areaName);
            saveAllData();
            populateAreaDropdowns();
            document.getElementById('newAreaName').value = '';
            alert('‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
        }

        function loadAreaForEdit(areaName) {
            document.getElementById('updatedAreaName').value = areaName;
        }

        function handleEditArea(e) {
            e.preventDefault();
            const oldArea = document.getElementById('existingAreaSelect').value;
            const newArea = document.getElementById('updatedAreaName').value.trim();

            if (!oldArea || !newArea) return;

            const areaIndex = DEMO_AREAS.indexOf(oldArea);
            if (areaIndex === -1) return;

            DEMO_AREAS[areaIndex] = newArea;

            customers.forEach(customer => {
                if (customer.area === oldArea) customer.area = newArea;
            });

            saveAllData();
            populateAreaDropdowns();
            alert('‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
        }

        function deleteArea() {
            const area = document.getElementById('existingAreaSelect').value;
            if (!area) return;

            if (customers.some(c => c.area === area)) {
                alert('‡¶è‡¶á ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶Ø‡¶º ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∞‡¶Ø‡¶º‡ßá‡¶õ‡ßá, ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡¶Ø‡¶º‡•§');
                return;
            }

            if (confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø "${area}" ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
                DEMO_AREAS = DEMO_AREAS.filter(a => a !== area);
                saveAllData();
                populateAreaDropdowns();
                alert('‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
            }
        }

        // User Management Functions
        function populateUserDropdowns() {
            const dropdown = document.getElementById('editUsername');
            dropdown.innerHTML = '<option value="">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';

            Object.entries(DEMO_USERS).forEach(([username, user]) => {
                if (username !== currentUsername) {
                    const option = document.createElement('option');
                    option.value = username;
                    option.textContent = `${user.name} (${username})`;
                    dropdown.appendChild(option);
                }
            });
        }

        function loadUserForEdit(username) {
            const user = DEMO_USERS[username];
            if (!user) return;

            document.getElementById('editPassword').value = '';
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserTarget').value = user.target;
        }

        function handleAddUser(e) {
            e.preventDefault();
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const name = document.getElementById('newUserName').value.trim();
            const role = document.getElementById('newUserRole').value;
            const target = parseInt(document.getElementById('newUserTarget').value);

            if (DEMO_USERS[username]) {
                alert('‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶®‡•§');
                return;
            }

            DEMO_USERS[username] = { password, role, name, target };
            saveAllData();
            populateUserDropdowns();
            e.target.reset();
            alert('‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
        }

        function handleEditUser(e) {
            e.preventDefault();
            const username = document.getElementById('editUsername').value;
            const password = document.getElementById('editPassword').value;
            const name = document.getElementById('editUserName').value.trim();
            const target = parseInt(document.getElementById('editUserTarget').value);

            if (!DEMO_USERS[username]) return;

            if (password) DEMO_USERS[username].password = password;
            DEMO_USERS[username].name = name;
            DEMO_USERS[username].target = target;

            saveAllData();
            populateUserDropdowns();
            alert('‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
        }

        function deleteUser() {
            const username = document.getElementById('editUsername').value;
            if (!username) return;

            if (username === currentUsername) {
                alert('‡¶Ü‡¶™‡¶®‡¶ø ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§');
                return;
            }

            if (confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø "${username}" ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
                delete DEMO_USERS[username];
                saveAllData();
                populateUserDropdowns();
                document.getElementById('editUserForm').reset();
                alert('‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
            }
        }

        // Reports Functions
        function renderTransactionTable() {
            const tbody = document.getElementById('transactionTableBody');
            tbody.innerHTML = '';

            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á‡•§</td></tr>';
                return;
            }

            const sortedTransactions = [...transactions].sort((a, b) => 
                new Date(b.created_at || b.time) - new Date(a.created_at || a.time)
            );

            sortedTransactions.forEach(transaction => {
                const date = new Date(transaction.created_at || transaction.time).toLocaleDateString('bn-BD');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${transaction.customer_name}</td>
                    <td>‡ß≥ ${transaction.package.toLocaleString()}</td>
                    <td>‡ß≥ ${transaction.amount.toLocaleString()}</td>
                    <td>${transaction.method}</td>
                    <td>${DEMO_USERS[transaction.collector]?.name || transaction.collector}</td>
                    <td><button class="btn-action" onclick="printReceipt(${transaction.id})"><i class="fas fa-print"></i></button></td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterTransactionsByDate() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                return;
            }

            const filtered = transactions.filter(t => {
                const tDate = new Date(t.created_at || t.time).toISOString().split('T')[0];
                return tDate >= startDate && tDate <= endDate;
            });

            const tbody = document.getElementById('transactionTableBody');
            tbody.innerHTML = '';

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á‡•§</td></tr>';
                return;
            }

            filtered.forEach(transaction => {
                const date = new Date(transaction.created_at || transaction.time).toLocaleDateString('bn-BD');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${transaction.customer_name}</td>
                    <td>‡ß≥ ${transaction.package.toLocaleString()}</td>
                    <td>‡ß≥ ${transaction.amount.toLocaleString()}</td>
                    <td>${transaction.method}</td>
                    <td>${DEMO_USERS[transaction.collector]?.name || transaction.collector}</td>
                    <td><button class="btn-action" onclick="printReceipt(${transaction.id})"><i class="fas fa-print"></i></button></td>
                `;
                tbody.appendChild(row);
            });
        }

        function printReceipt(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            const customer = customers.find(c => c.id === transaction.customer_id);
            const receiptWindow = window.open('', '_blank');
            receiptWindow.document.write(`
                <html>
                    <head><title>‡¶∞‡¶ø‡¶∏‡¶ø‡¶™‡ßç‡¶ü #${transaction.id}</title></head>
                    <body style="font-family: Arial; padding: 20px;">
                        <h2>‡¶¨‡¶ø‡¶≤ ‡¶∞‡¶ø‡¶∏‡¶ø‡¶™‡ßç‡¶ü</h2>
                        <p><strong>‡¶∞‡¶ø‡¶∏‡¶ø‡¶™‡ßç‡¶ü ‡¶®‡¶Ç:</strong> ${transaction.id}</p>
                        <p><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> ${new Date(transaction.created_at || transaction.time).toLocaleString('bn-BD')}</p>
                        <p><strong>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï:</strong> ${transaction.customer_name}</p>
                        <p><strong>‡¶´‡ßã‡¶®:</strong> ${customer?.phone || 'N/A'}</p>
                        <p><strong>‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ:</strong> ${customer?.area || 'N/A'}</p>
                        <p><strong>‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú:</strong> ‡ß≥ ${transaction.package}</p>
                        <p><strong>‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º‡¶ï‡ßÉ‡¶§:</strong> ‡ß≥ ${transaction.amount}</p>
                        <p><strong>‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø:</strong> ${transaction.method}</p>
                        <p><strong>‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡¶∞:</strong> ${DEMO_USERS[transaction.collector]?.name || transaction.collector}</p>
                        <hr>
                        <p style="text-align: center;">‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶</p>
                        <button onclick="window.print()" style="margin-top: 20px;">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </body>
                </html>
            `);
            receiptWindow.document.close();
        }

        function exportTransactionToCSV() {
            let csvContent = "‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ,‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï,‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú,‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º,‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø,‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡¶∞\n";
            transactions.forEach(t => {
                const date = new Date(t.created_at || t.time).toLocaleDateString('bn-BD');
                csvContent += `${date},${t.customer_name},${t.package},${t.amount},${t.method},${DEMO_USERS[t.collector]?.name || t.collector}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `transactions_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Collector Management
        function renderCollectorPerformance() {
            const tbody = document.querySelector('#collectorPerformanceTable tbody');
            tbody.innerHTML = '';

            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            Object.entries(DEMO_USERS).forEach(([username, user]) => {
                if (user.role === USER_ROLES.COLLECTOR) {
                    const userTransactions = transactions.filter(t => 
                        t.collector === username && 
                        new Date(t.created_at || t.time).getMonth() === currentMonth && 
                        new Date(t.created_at || t.time).getFullYear() === currentYear
                    );

                    const totalCollection = userTransactions.reduce((sum, t) => sum + t.amount, 0);
                    const targetPercentage = user.target > 0 ? Math.round((totalCollection / user.target) * 100) : 0;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${username}</td>
                        <td>‡ß≥ ${totalCollection.toLocaleString()}</td>
                        <td style="color: ${targetPercentage >= 100 ? 'green' : targetPercentage >= 80 ? 'orange' : 'red'}">${targetPercentage}%</td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        // System Automation
        function autoGenerateBill() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            customers.forEach(customer => {
                if (customer.status === 'Active') {
                    const hasPaidThisMonth = transactions.some(t => {
                        const tDate = new Date(t.created_at || t.time);
                        return t.customer_id === customer.id && 
                               tDate.getMonth() === currentMonth && 
                               tDate.getFullYear() === currentYear;
                    });

                    if (!hasPaidThisMonth) {
                        customer.due = true;
                    }
                }
            });

            saveAllData();
            alert('‡¶Ö‡¶ü‡ßã ‡¶¨‡¶ø‡¶≤ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
            updateDashboard();
            renderCustomerTable();
        }

        function exportData(type) {
            let data, filename, mimeType;

            if (type === 'csv') {
                let csvContent = "‡¶Ü‡¶á‡¶°‡¶ø,‡¶®‡¶æ‡¶Æ,‡¶´‡ßã‡¶®,‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ,‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú,‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏,‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ\n";
                customers.forEach(c => {
                    csvContent += `${c.id},${c.name},${c.phone},${c.area},${c.package},${c.status},${c.due ? '‡¶π‡ßç‡¶Ø‡¶æ‡¶Å' : '‡¶®‡¶æ'}\n`;
                });
                data = csvContent;
                filename = `customers_${new Date().toISOString().split('T')[0]}.csv`;
                mimeType = 'text/csv;charset=utf-8;';
            } else if (type === 'json') {
                const allData = {
                    users: DEMO_USERS,
                    areas: DEMO_AREAS,
                    customers: customers,
                    transactions: transactions
                };
                data = JSON.stringify(allData, null, 2);
                filename = `billing_backup_${new Date().toISOString().split('T')[0]}.json`;
                mimeType = 'application/json';
            }

            const blob = new Blob([data], { type: mimeType });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            const savedRole = localStorage.getItem('currentRole');
            const savedUsername = localStorage.getItem('currentUsername');

            if (savedRole && savedUsername) {
                currentRole = savedRole;
                currentUsername = savedUsername;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                initializeApp();
            }
        });
    </script>
</body>
</html>
